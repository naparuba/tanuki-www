<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Online course 4: High Availability / Some monitoring guys</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="shortcut icon" href="/theme/favicon.ico" />
        <link rel="apple-touch-icon" href="/theme/apple-touch-icon-iphone.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="/theme/apple-touch-icon-ipad.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="/theme/apple-touch-icon-iphone4.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="/theme/apple-touch-icon-ipad3.png" />

        <link rel="stylesheet" href="/theme/css/bootstrap.min.css">
        <link rel="stylesheet" href="/theme/css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="/theme/css/colorbox.css">

        <link rel="stylesheet" href="/theme/css/main.css">

        <script src="/theme/js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div class="container-fluid">
            <div class="row-fluid">

	      <a class='span4' href='/'> Home</a>
	      <a class='span1' href='/intro/index.html'>Intro</a>
	      <a class='span1' href='/docs/index.html'>Docs</a>
	      <a class='span1' href='/community.html'>Community</a>
	      <a class='span1' href='/demo.html'>Demo</a>
	      <a class='span2' href='/download.html'>Download</a>
	      <a class='span2' href='github'>Github</a>
	    </div>
            <div class="row-fluid">
                <div class="span4" id='content'>
		  

                </div> <!-- logo+navigation span -->


                <div class="span8">
                    <header id="site-header">
                        <h1>
                            <a href="">Some monitoring guys</a>
                            <small>
                                <span class="divider">/</span> 
                            </small>
                        </h1>
                        <!--<p>
                            
                        </p>-->
                    </header>

                    <div class="content">
<section>
    <article>
        <header>
            <h2><a href="/online-course-4-high-availability/" rel="bookmark">Online course 4: High Availability</a></h2>
            <time datetime="2014-03-19T10:20:00">Mar 19, 2014</time>
	    <span class='author'>, Gab√®s Jean</span>

        </header>

    <p>Hi,</p>
<p>This is our 4th online course, we are using the shinken distributed capabilities to setup a truly high available setup :)</p>
<p>We already saw the installation of the 2.0 version in a linux box, but now we want to try the huge shinken distributed capabilities with a simple one: a high avaiability one.</p>
<p>In shinken this is managed like a disk RAID: you can define spare daemons that will take the job if a master one is down :)</p>
<p>You can follow this tutorial with this video:</p>
<iframe width="800" height="600" src="//www.youtube.com/embed/WmJbje_bdz4" frameborder="0" allowfullscreen></iframe>

<p>(I cut the video at 6:15 because I give a looooong look at the logs there)</p>
<p>(You can also have a <a href="https://www.youtube.com/watch?v=nGSwROwGfBs">fr version of the video</a>.</p>
<h3>Our setup with 2 linux boxes</h3>
<p>We will have 2 linux and we want a simple high availability setup, with box courses-a and courses-b. A will be the master one, and the B will be the spare one. We just installed shinken in the 2 boxes. Both got a valid dns entry :</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="p">[...]</span>
<span class="mf">192.168.56.104</span>  <span class="n">courses</span><span class="o">-</span><span class="n">a</span>
<span class="mf">192.168.56.105</span>  <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span>
<span class="p">[...]</span>
<span class="mf">192.168.56.104</span>  <span class="n">courses</span><span class="o">-</span><span class="n">a</span>
<span class="mf">192.168.56.105</span>  <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
</pre></div>


<p>First we will focus in the <code>courses-a</code> box. We will configure all daemons in the cfg of the master, and we will just copy all cfg files into the spare when we will be done.</p>
<p>We have to copy all our daemon <code>master</code> configurations, give them a new name and the good address (we will keep the default ports).</p>
<p>We want to have something like this :</p>
<p><img src='/images/course4/courses-4-master.png'></p>
<p>First let's look at the <code>arbiter</code> daemons, that is done to read and dispatch the configurations:</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiters</span><span class="o">/</span><span class="n">arbiter</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiters</span><span class="o">/</span><span class="n">arbiter</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiters</span><span class="o">/</span><span class="n">arbiter</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">arbiter</span> <span class="p">{</span>
    <span class="n">arbiter_name</span>    <span class="n">arbiter</span><span class="o">-</span><span class="n">spare</span>
    <span class="n">host_name</span>       <span class="n">courses</span><span class="o">-</span><span class="n">b</span>       <span class="p">;</span> <span class="n">CHANGE</span> <span class="n">THIS</span> <span class="k">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">several</span> <span class="n">Arbiters</span>
    <span class="n">address</span>         <span class="n">courses</span><span class="o">-</span><span class="n">b</span>   <span class="p">;</span> <span class="n">DNS</span> <span class="n">name</span> <span class="n">or</span> <span class="n">IP</span>
    <span class="n">port</span>            <span class="mi">7770</span>
    <span class="n">spare</span>           <span class="mi">1</span>           <span class="p">;</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">is</span> <span class="n">a</span> <span class="n">spare</span><span class="p">,</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">spare</span>
    <span class="n">modules</span>      <span class="n">CommandFile</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
<span class="p">}</span>
</pre></div>


<p>We changed <code>arbiter_name</code>, <code>host_name</code>, <code>address</code> and <code>spare</code> properties. If the name is obvious, the others parameters are not :</p>
<ul>
<li><code>host_name</code> : specific to the arbiter, is is used by the arbiter daemon to find the arbiter object that match its <code>hostname</code></li>
<li><code>address</code> : where the arbiter master will have to connect to exchange data</li>
<li><code>spare</code> : is this daemon a spare one or not? :)</li>
</ul>
<p>The <code>host_name</code> parameter is important because the arbiter process will launch a <code>hostname</code> command to find where its launched, and then find a matching arbiter object.</p>
<p>We also need to edit the <code>arbiter-master</code> to be sure its <code>address</code> is the public ip and not <code>localhost</code> as by default.</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiters</span><span class="o">/</span><span class="n">arbiter</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span>    
<span class="n">define</span> <span class="n">arbiter</span> <span class="p">{</span>
    <span class="n">arbiter_name</span>    <span class="n">arbiter</span><span class="o">-</span><span class="n">master</span>
    <span class="n">host_name</span>       <span class="n">courses</span><span class="o">-</span><span class="n">a</span>       <span class="p">;</span> <span class="n">CHANGE</span> <span class="n">THIS</span> <span class="k">if</span> <span class="n">you</span> <span class="n">have</span> <span class="n">several</span> <span class="n">Arbiters</span>
    <span class="n">address</span>         <span class="n">courses</span><span class="o">-</span><span class="n">a</span>   <span class="p">;</span> <span class="n">DNS</span> <span class="n">name</span> <span class="n">or</span> <span class="n">IP</span>
    <span class="n">port</span>            <span class="mi">7770</span>
    <span class="n">spare</span>           <span class="mi">0</span>           <span class="p">;</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">is</span> <span class="n">a</span> <span class="n">spare</span><span class="p">,</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">spare</span>
<span class="p">}</span>
</pre></div>


<p>Then we need to do the same for all the other daemons now :)</p>
<p>The <code>schedulers</code> (scheduler the checks) :</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">schedulers</span><span class="o">/</span><span class="n">scheduler</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">schedulers</span><span class="o">/</span><span class="n">scheduler</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">schedulers</span><span class="o">/</span><span class="n">scheduler</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">scheduler</span> <span class="p">{</span>
    <span class="n">scheduler_name</span>      <span class="n">scheduler</span><span class="o">-</span><span class="n">spare</span> <span class="p">;</span> <span class="n">Just</span> <span class="n">the</span> <span class="n">name</span>
    <span class="n">address</span>             <span class="n">courses</span><span class="o">-</span><span class="n">b</span>   <span class="p">;</span> <span class="n">IP</span> <span class="n">or</span> <span class="n">DNS</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">daemon</span>
    <span class="n">port</span>                <span class="mi">7768</span>        <span class="p">;</span> <span class="n">TCP</span> <span class="n">port</span> <span class="n">of</span> <span class="n">the</span> <span class="n">daemon</span>
    <span class="n">spare</span>               <span class="mi">1</span>   <span class="p">;</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">is</span> <span class="n">a</span> <span class="n">spare</span><span class="p">,</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">spare</span>

    <span class="n">weight</span>              <span class="mi">1</span>   <span class="p">;</span> <span class="n">Some</span> <span class="n">schedulers</span> <span class="n">can</span> <span class="n">manage</span> <span class="n">more</span> <span class="n">hosts</span> <span class="n">than</span> <span class="n">others</span>
    <span class="n">timeout</span>             <span class="mi">3</span>   <span class="p">;</span> <span class="n">Ping</span> <span class="n">timeout</span>
    <span class="n">data_timeout</span>        <span class="mi">120</span> <span class="p">;</span> <span class="n">Data</span> <span class="n">send</span> <span class="n">timeout</span>
    <span class="n">max_check_attempts</span>  <span class="mi">3</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">ping</span> <span class="n">fails</span> <span class="n">N</span> <span class="n">or</span> <span class="n">more</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">node</span> <span class="n">is</span> <span class="n">dead</span>
    <span class="n">check_interval</span>      <span class="mi">60</span>  <span class="p">;</span> <span class="n">Ping</span> <span class="n">node</span> <span class="n">every</span> <span class="n">N</span> <span class="n">seconds</span>
    <span class="n">modules</span>
    <span class="n">realm</span>   <span class="n">All</span>
    <span class="n">skip_initial_broks</span>  <span class="mi">0</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
<span class="p">}</span>
</pre></div>


<p>The <code>pollers</code> (launch the monitoring plugins).</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">pollers</span><span class="o">/</span><span class="n">poller</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">pollers</span><span class="o">/</span><span class="n">poller</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span> 
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">pollers</span><span class="o">/</span><span class="n">poller</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">poller</span> <span class="p">{</span>
    <span class="n">poller_name</span>     <span class="n">poller</span><span class="o">-</span><span class="n">master</span>
    <span class="n">address</span>         <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
    <span class="n">port</span>            <span class="mi">7771</span>
    <span class="n">spare</span>           <span class="mi">1</span>

    <span class="n">manage_sub_realms</span>   <span class="mi">0</span>   <span class="p">;</span> <span class="n">Does</span> <span class="n">it</span> <span class="n">take</span> <span class="n">jobs</span> <span class="n">from</span> <span class="n">schedulers</span> <span class="n">of</span> <span class="n">sub</span><span class="o">-</span><span class="n">Realms</span><span class="o">?</span>
    <span class="n">min_workers</span>         <span class="mi">0</span>   <span class="p">;</span> <span class="n">Starts</span> <span class="n">with</span> <span class="n">N</span> <span class="n">processes</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">per</span> <span class="n">CPU</span><span class="p">)</span>
    <span class="n">max_workers</span>         <span class="mi">0</span>   <span class="p">;</span> <span class="n">No</span> <span class="n">more</span> <span class="n">than</span> <span class="n">N</span> <span class="n">processes</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">per</span> <span class="n">CPU</span><span class="p">)</span>
    <span class="n">processes_by_worker</span> <span class="mi">256</span> <span class="p">;</span> <span class="n">Each</span> <span class="n">worker</span> <span class="n">manages</span> <span class="n">N</span> <span class="n">checks</span>
    <span class="n">polling_interval</span>    <span class="mi">1</span>   <span class="p">;</span> <span class="n">Get</span> <span class="n">jobs</span> <span class="n">from</span> <span class="n">schedulers</span> <span class="n">each</span> <span class="n">N</span> <span class="n">minutes</span>
    <span class="n">timeout</span>             <span class="mi">3</span>   <span class="p">;</span> <span class="n">Ping</span> <span class="n">timeout</span>
    <span class="n">data_timeout</span>        <span class="mi">120</span> <span class="p">;</span> <span class="n">Data</span> <span class="n">send</span> <span class="n">timeout</span>
    <span class="n">max_check_attempts</span>  <span class="mi">3</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">ping</span> <span class="n">fails</span> <span class="n">N</span> <span class="n">or</span> <span class="n">more</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">node</span> <span class="n">is</span> <span class="n">dead</span>
    <span class="n">check_interval</span>      <span class="mi">60</span>  <span class="p">;</span> <span class="n">Ping</span> <span class="n">node</span> <span class="n">every</span> <span class="n">N</span> <span class="n">seconds</span>
    <span class="n">modules</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
    <span class="n">realm</span>   <span class="n">All</span>
<span class="p">}</span>
</pre></div>


<p>Same for the <code>reactionners</code> (launch the notifications and the event handlers):</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">reactionners</span><span class="o">/</span><span class="n">reactionner</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">reactionners</span><span class="o">/</span><span class="n">reactionner</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">reactionners</span><span class="o">/</span><span class="n">reactionner</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">reactionner</span> <span class="p">{</span>
    <span class="n">reactionner_name</span>    <span class="n">reactionner</span><span class="o">-</span><span class="n">master</span>
    <span class="n">address</span>             <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
    <span class="n">port</span>                <span class="mi">7769</span>
    <span class="n">spare</span>               <span class="mi">1</span>

    <span class="n">manage_sub_realms</span>   <span class="mi">0</span>   <span class="p">;</span> <span class="n">Does</span> <span class="n">it</span> <span class="n">take</span> <span class="n">jobs</span> <span class="n">from</span> <span class="n">schedulers</span> <span class="n">of</span> <span class="n">sub</span><span class="o">-</span><span class="n">Realms</span><span class="o">?</span>
    <span class="n">min_workers</span>         <span class="mi">1</span>   <span class="p">;</span> <span class="n">Starts</span> <span class="n">with</span> <span class="n">N</span> <span class="n">processes</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">per</span> <span class="n">CPU</span><span class="p">)</span>
    <span class="n">max_workers</span>         <span class="mi">15</span>  <span class="p">;</span> <span class="n">No</span> <span class="n">more</span> <span class="n">than</span> <span class="n">N</span> <span class="n">processes</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">per</span> <span class="n">CPU</span><span class="p">)</span>
    <span class="n">polling_interval</span>    <span class="mi">1</span>   <span class="p">;</span> <span class="n">Get</span> <span class="n">jobs</span> <span class="n">from</span> <span class="n">schedulers</span> <span class="n">each</span> <span class="mi">1</span> <span class="n">second</span>
    <span class="n">timeout</span>             <span class="mi">3</span>   <span class="p">;</span> <span class="n">Ping</span> <span class="n">timeout</span>
    <span class="n">data_timeout</span>        <span class="mi">120</span> <span class="p">;</span> <span class="n">Data</span> <span class="n">send</span> <span class="n">timeout</span>
    <span class="n">max_check_attempts</span>  <span class="mi">3</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">ping</span> <span class="n">fails</span> <span class="n">N</span> <span class="n">or</span> <span class="n">more</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">node</span> <span class="n">is</span> <span class="n">dead</span>
    <span class="n">check_interval</span>      <span class="mi">60</span>  <span class="p">;</span> <span class="n">Ping</span> <span class="n">node</span> <span class="n">every</span> <span class="n">N</span> <span class="n">seconds</span>
    <span class="n">modules</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
    <span class="n">realm</span>   <span class="n">All</span>
<span class="p">}</span>
</pre></div>


<p>Now for the <code>brokers</code> (grab events and data from the other daemons and export them):</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">brokers</span><span class="o">/</span><span class="n">broker</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">brokers</span><span class="o">/</span><span class="n">broker</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">brokers</span><span class="o">/</span><span class="n">broker</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">broker</span> <span class="p">{</span>
    <span class="n">broker_name</span>     <span class="n">broker</span><span class="o">-</span><span class="n">master</span>
    <span class="n">address</span>         <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
    <span class="n">port</span>            <span class="mi">7772</span>
    <span class="n">spare</span>           <span class="mi">1</span>

    <span class="n">manage_arbiters</span>     <span class="mi">1</span>   <span class="p">;</span> <span class="n">Take</span> <span class="n">data</span> <span class="n">from</span> <span class="n">Arbiter</span><span class="p">.</span> <span class="n">There</span> <span class="n">should</span> <span class="n">be</span> <span class="n">only</span> <span class="n">one</span>
    <span class="n">manage_sub_realms</span>   <span class="mi">1</span>   <span class="p">;</span> <span class="n">Does</span> <span class="n">it</span> <span class="n">take</span> <span class="n">jobs</span> <span class="n">from</span> <span class="n">schedulers</span> <span class="n">of</span> <span class="n">sub</span><span class="o">-</span><span class="n">Realms</span><span class="o">?</span>
    <span class="n">timeout</span>             <span class="mi">3</span>   <span class="p">;</span> <span class="n">Ping</span> <span class="n">timeout</span>
    <span class="n">data_timeout</span>        <span class="mi">120</span> <span class="p">;</span> <span class="n">Data</span> <span class="n">send</span> <span class="n">timeout</span>
    <span class="n">max_check_attempts</span>  <span class="mi">3</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">ping</span> <span class="n">fails</span> <span class="n">N</span> <span class="n">or</span> <span class="n">more</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">node</span> <span class="n">is</span> <span class="n">dead</span>
    <span class="n">check_interval</span>      <span class="mi">60</span>  <span class="p">;</span> <span class="n">Ping</span> <span class="n">node</span> <span class="n">every</span> <span class="n">N</span> <span class="n">seconds</span>

    <span class="n">modules</span>           <span class="n">WebUI</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
    <span class="n">realm</span>   <span class="n">All</span>
<span class="p">}</span>
</pre></div>


<p>And finaly the <code>receivers</code> (listen to external commands):</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">receivers</span><span class="o">/</span><span class="n">receiver</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">receivers</span><span class="o">/</span><span class="n">receiver</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">receivers</span><span class="o">/</span><span class="n">receiver</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">receiver</span> <span class="p">{</span>
    <span class="n">receiver_name</span>   <span class="n">receiver</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">address</span>         <span class="n">courses</span><span class="o">-</span><span class="n">b</span>
    <span class="n">port</span>            <span class="mi">7773</span>
    <span class="n">spare</span>           <span class="mi">1</span>

    <span class="n">timeout</span>             <span class="mi">3</span>   <span class="p">;</span> <span class="n">Ping</span> <span class="n">timeout</span>
    <span class="n">data_timeout</span>        <span class="mi">120</span> <span class="p">;</span> <span class="n">Data</span> <span class="n">send</span> <span class="n">timeout</span>
    <span class="n">max_check_attempts</span>  <span class="mi">3</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">ping</span> <span class="n">fails</span> <span class="n">N</span> <span class="n">or</span> <span class="n">more</span><span class="p">,</span> <span class="n">then</span> <span class="n">the</span> <span class="n">node</span> <span class="n">is</span> <span class="n">dead</span>
    <span class="n">check_interval</span>      <span class="mi">60</span>  <span class="p">;</span> <span class="n">Ping</span> <span class="n">node</span> <span class="n">every</span> <span class="n">N</span> <span class="n">seconds</span>
    <span class="n">modules</span>
    <span class="n">use_ssl</span>          <span class="mi">0</span>
    <span class="n">direct_routing</span>      <span class="mi">0</span>   <span class="p">;</span> <span class="n">If</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">directly</span> <span class="n">send</span> <span class="n">commands</span> <span class="n">to</span> <span class="n">the</span>
                            <span class="p">;</span> <span class="n">schedulers</span> <span class="k">if</span> <span class="n">it</span> <span class="n">know</span> <span class="n">about</span> <span class="n">the</span> <span class="n">hostname</span> <span class="n">in</span> <span class="n">the</span>                                                                              <span class="p">;</span> <span class="n">command</span><span class="p">.</span>
    <span class="n">realm</span>   <span class="n">All</span>
<span class="p">}</span>
</pre></div>


<p>Remember to also change the <code>address</code> entry of all master daemons, because the spare <code>arbiter</code> will need the LAN IP if it takes the lead and need to dispatch the configuration :)</p>
<p>Then you can copy the <code>courses-a</code> server configuration over the <code>courses-b</code> one. They must be the same.</p>
<div class="highlight"><pre><span class="n">shinken</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">scp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/*</span> <span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span>
</pre></div>


<p>Then restart <code>shinken</code> on both servers:</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shinken</span> <span class="n">start</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shinken</span> <span class="n">start</span>
</pre></div>


<p>The <code>arbiter-master</code> will talk each second to the <code>arbiter-spare</code> to say it is still alive, and so the <code>spare</code> must keep calm :)</p>
<p>If we look at the spare logs, all is clean :</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiterd</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>When we stop the <code>courses-a</code> daemons the <code>arbiter-spare</code> will take the configuration lead after <code>max_check_attempts*check_interval</code> seconds (from the <code>arbiter-master configuration</code> and will dispatch to the only available daemons, the <code>spare</code> ones.</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">shinken</span> <span class="n">stop</span>
<span class="p">[</span><span class="n">wait</span> <span class="mi">3</span> <span class="n">min</span><span class="p">]</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="n">grep</span> <span class="err">&#39;</span><span class="n">Dispatch</span> <span class="n">OK</span><span class="err">&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">arbiterd</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>We got something like this:</p>
<p><img src='/images/course4/courses-4-spare.png'></p>
<h2>Issue with the PENDING states</h2>
<p>But one problem we got when we switch to the spare daemons are that all checks are restarting from the <code>PENDING</code> state, but we don't wantto loose all our previous states. If we are using a flat file retention module for the <code>schedulers</code> like the <code>pickle-retention-file-scheduler</code> one the courses-b server won't be able to read the courses-a flat file of course. We must use a distributed retention module :)</p>
<p>Just look at what is available :</p>
<div class="highlight"><pre><span class="n">shinken</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">shinken</span> <span class="n">search</span> <span class="n">retention</span>
<span class="n">pickle</span><span class="o">-</span><span class="n">retention</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">generic</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">arbiter</span><span class="p">,</span><span class="n">broker</span><span class="p">,</span><span class="n">retention</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span><span class="o">/</span><span class="n">saving</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">file</span> <span class="p">(</span><span class="k">for</span> <span class="n">arbiter</span> <span class="o">&amp;</span> <span class="n">broker</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">-</span><span class="n">retention</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">scheduler</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">scheduler</span><span class="p">,</span><span class="n">retention</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span><span class="o">/</span><span class="n">saving</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">flat</span> <span class="n">file</span> <span class="p">(</span><span class="k">for</span> <span class="n">scheduler</span><span class="p">)</span>
<span class="n">retention</span><span class="o">-</span><span class="n">memcache</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">scheduler</span><span class="p">,</span><span class="n">retention</span><span class="p">,</span><span class="n">memcache</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span><span class="o">/</span><span class="n">saving</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">memcache</span> <span class="n">server</span>
<span class="n">retention</span><span class="o">-</span><span class="n">mongodb</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">scheduler</span><span class="p">,</span><span class="n">retention</span><span class="p">,</span><span class="n">nagios</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span><span class="o">/</span><span class="n">saving</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">mongodb</span> <span class="n">cluster</span>
<span class="n">retention</span><span class="o">-</span><span class="n">nagios</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">scheduler</span><span class="p">,</span><span class="n">retention</span><span class="p">,</span><span class="n">nagios</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">nagios</span> <span class="n">flat</span> <span class="n">file</span><span class="p">.</span> <span class="n">Useful</span> <span class="k">for</span> <span class="n">migration</span> <span class="n">to</span> <span class="n">Shinken</span> <span class="n">from</span> <span class="n">Nagios</span>
<span class="n">retention</span><span class="o">-</span><span class="n">redis</span> <span class="p">(</span><span class="n">naparuba</span><span class="p">)</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span><span class="n">scheduler</span><span class="p">,</span><span class="n">retention</span><span class="p">,</span><span class="n">redis</span><span class="p">]</span> <span class="o">:</span> <span class="n">Module</span> <span class="k">for</span> <span class="n">loading</span><span class="o">/</span><span class="n">saving</span> <span class="n">retention</span> <span class="n">data</span> <span class="n">from</span> <span class="n">a</span> <span class="n">redis</span> <span class="n">cluster</span>
</pre></div>


<p>The one that is interesting us is the retention-mongodb one. Let's install it:</p>
<div class="highlight"><pre><span class="n">shinken</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">shinken</span> <span class="n">install</span> <span class="n">retention</span><span class="o">-</span><span class="n">mongodb</span>
</pre></div>


<p>But beware, we also need to install it on the <code>courses-b</code> server !</p>
<div class="highlight"><pre><span class="n">shinken</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="n">shinken</span> <span class="n">install</span> <span class="n">retention</span><span class="o">-</span><span class="n">mongodb</span>
</pre></div>


<p>This module will need some additionals python lib, on both servers of course :</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">pymongo</span> <span class="n">python</span><span class="o">-</span><span class="n">gridfs</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="err">$</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">pymongo</span> <span class="n">python</span><span class="o">-</span><span class="n">gridfs</span>
</pre></div>


<p>We will have such architecture:</p>
<p><img src='/images/course4/courses-4-retention.png'></p>
<p>We will need a mongodb server. I'll install it on another server. You can easily setup it by folowing the <a href="http://docs.mongodb.org/manual/administration/install-on-linux/">documentation</a>. It will be on te <code>192.168.56.103</code> server for me.</p>
<p>The module configuration is <code>/etc/shinken/modules/retention-mongodb.cfg</code>:</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">retention</span><span class="o">-</span><span class="n">mongodb</span><span class="p">.</span><span class="n">cfg</span>
<span class="n">define</span> <span class="n">module</span> <span class="p">{</span>
    <span class="n">module_name</span>     <span class="n">MongodbRetention</span>
    <span class="n">module_type</span>     <span class="n">mongodb_retention</span>
    <span class="n">uri</span>             <span class="n">mongodb</span><span class="o">:</span><span class="c1">//192.168.56.103/?safe=false</span>
    <span class="n">database</span>        <span class="n">shinken</span>
<span class="p">}</span>
</pre></div>


<p>Note that you need to edit the uri with your server address :)</p>
<p>Then we can just enable the module on <code>both</code> schedulers:</p>
<div class="highlight"><pre><span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">schedulers</span><span class="o">/</span><span class="n">scheduler</span><span class="o">-</span><span class="n">master</span><span class="p">.</span><span class="n">cfg</span>
<span class="p">[..]</span>
<span class="n">modules</span>    <span class="n">MongodbRetention</span>
<span class="p">[...]</span>
<span class="n">root</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span><span class="n">schedulers</span><span class="o">/</span><span class="n">scheduler</span><span class="o">-</span><span class="n">spare</span><span class="p">.</span><span class="n">cfg</span>
<span class="p">[..]</span>
<span class="n">modules</span>    <span class="n">MongodbRetention</span>
<span class="p">[...]</span>
</pre></div>


<p>Then copy your configuration from <code>courses-a</code> to <code>courses-b</code> with the previous <code>scp</code> command.</p>
<div class="highlight"><pre><span class="n">shinken</span><span class="err">@</span><span class="n">courses</span><span class="o">-</span><span class="n">a</span><span class="err">$</span> <span class="n">scp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/*</span> <span class="n">courses</span><span class="o">-</span><span class="n">b</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">shinken</span><span class="o">/</span>
</pre></div>


<p>Then you can restart boths servers and try to stop the <code>master</code> daemons one time again. This time the retention data will be ok :)</p>
<h3>The next course</h3>
<p>The next course will be about a focus on the enterprise edition, the next one will be about the shinken daemons and what they are done for :)</p>



<p style='border: 2px solid rgba(0,39,59,.2);border-radius: 4px;'><img style='width: 48px;'  data-role="user-avatar" data-user="94550631" src="//a.disquscdn.com/uploads/users/9455/631/avatar92.jpg?1392209481"><a href='#'> jean gab√®s </a>
<a href='mailto:j.gabes@shinken-solutions.com'><img src="/theme/img/Mail.png" /></a>
<a href='https://twitter.com/naparuba'><img src="/theme/img/Twitter.png" /></a>
<a href='https://github.com/naparuba'><img src="/theme/img/GitHub.png" /></a>
</p>
    <footer>
        <p>Posted in: <a href="/category/talk.html">Talk</a></p>
        <p>Tagged as: <a href="/tag/shinken.html">shinken</a> / <a href="/tag/online-course.html">online course</a> / <a href="/tag/high-availability.html">high availability</a> / <a href="/tag/raid.html">raid</a></p>
        <p>Wanna tell me what you think? <a href="/">Get in touch.</a></p>
    </footer>

<hr/>

<div id="disqus_thread"></div>
  <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shinkenlabio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


        </footer>
    </article>
</section>                    </div>

                    <footer id="site-footer">
                        <p>
                            <a href="" target="_blank">
                                
                            </a> Shinken framework team /
                            <a href="/">Archives</a>
                            / Powered by
                            <a href="https://github.com/getpelican/pelican" target="_blank">
                                Pelican
                            </a>
                        </p>
                    </footer>
                </div> <!-- header+content+footer span -->

            </div> <!-- row -->
        </div> <!-- /container -->

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/theme/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>

        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.0/js/bootstrap.min.js"></script>
        <script>$('body').popover || document.write('<script src="/theme/js/vendor/bootstrap.min.js"><\/script>')</script>

        <script src="/theme/js/vendor/jquery.colorbox-min.js"></script>

        <script src="/theme/js/main.js"></script>

        <script>
            var _gaq=[['_setAccount','UA-48477803-1'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>